<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>华巡网络设备巡检系统</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root {
            --primary-color: #409EFF;
            --success-color: #67C23A;
            --warning-color: #E6A23C;
            --danger-color: #F56C6C;
            --background-color: #f0f2f5;
            --card-background: #ffffff;
            --text-color: #303133;
            --border-color: #DCDFE6;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 500;
        }

        .header .el-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header .el-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .card {
            background: var(--card-background);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
        }

        .card h2 {
            margin-top: 0;
            color: var(--text-color);
            font-size: 18px;
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .device-list, .inspection-records {
            background: var(--card-background);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
        }

        .el-table {
            border-radius: 4px;
            overflow: hidden;
        }

        .el-table th {
            background-color: #f5f7fa !important;
            color: var(--text-color);
            font-weight: 500;
        }

        .el-table td {
            padding: 12px 0;
        }

        .el-button--primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #3a8ee6 100%);
            border: none;
        }

        .el-button--primary:hover {
            background: linear-gradient(135deg, #3a8ee6 0%, #2d7fd9 100%);
        }

        .el-tag {
            border-radius: 4px;
            padding: 0 10px;
            height: 24px;
            line-height: 24px;
        }

        .el-dialog {
            border-radius: 8px;
            overflow: hidden;
        }

        .el-dialog__header {
            background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
            padding: 15px 20px;
        }

        .el-dialog__title {
            color: white;
        }

        .el-dialog__headerbtn .el-dialog__close {
            color: white;
        }

        .el-form-item__label {
            font-weight: 500;
        }

        .el-input__inner {
            border-radius: 4px;
        }

        .el-select {
            width: 100%;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-online {
            background-color: #67C23A;
            color: white;
        }
        .status-offline {
            background-color: #F56C6C;
            color: white;
        }
        .status-unknown {
            background-color: #909399;
            color: white;
        }
        .el-button.is-disabled {
            cursor: not-allowed;
        }
        .last-check {
            font-size: 12px;
            color: #909399;
        }

        .inspection-result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .command-tips {
            margin-top: 10px;
            font-size: 12px;
            color: #909399;
        }
        
        .command-tips ul {
            margin: 5px 0;
            padding-left: 20px;
        }
        
        .command-tips li {
            margin: 3px 0;
        }

        .command-result {
            margin-bottom: 20px;
            border: 1px solid #EBEEF5;
            border-radius: 4px;
            overflow: hidden;
        }
        .command-title {
            background-color: #F5F7FA;
            padding: 8px 12px;
            font-weight: bold;
            border-bottom: 1px solid #EBEEF5;
        }
        .command-output {
            margin: 0;
            padding: 12px;
            background-color: #FFFFFF;
            white-space: pre;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
        }
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        .el-button [class^="el-icon-"] {
            margin-right: 5px;
        }
        .upload-demo {
            text-align: center;
        }
        .el-upload-dragger {
            width: 100%;
        }
        .el-upload__tip {
            margin-top: 10px;
            color: #909399;
        }
        .operation-buttons {
            display: flex;
            gap: 4px;
            justify-content: flex-start;
            flex-wrap: nowrap;
        }
        .operation-buttons .el-button {
            padding: 5px 10px;
            font-size: 12px;
            line-height: 1.5;
            min-width: 52px;
        }
        .operation-buttons .el-button + .el-button {
            margin-left: 0;
        }
        .compact-table .el-table td {
            padding: 8px 0;
        }
        .inspection-progress {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .inspection-progress-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .progress-title {
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        .progress-info {
            margin-top: 15px;
            color: #606266;
        }
        .inspection-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--primary-color);
            animation: rotating 2s linear infinite;
        }
        @keyframes rotating {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        .current-time {
            color: white;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            line-height: 1.5;
        }
        .current-time .date-time {
            font-size: 16px;
            font-weight: 500;
        }
        .current-time .lunar-week {
            font-size: 12px;
            opacity: 0.9;
        }
        .footer {
            background: transparent;
            color: #606266;
            padding: 16px 20px;
            border-top: 1px solid #EBEEF5;
            margin-top: 30px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }
        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .footer-logo {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
            letter-spacing: 1px;
            color: #303133;
        }
        .footer-copyright {
            font-size: 13px;
            margin-bottom: 8px;
            color: #909399;
        }
        .footer-links {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }
        .footer-links a {
            color: #409EFF;
            text-decoration: none;
            font-size: 12px;
            transition: color 0.3s;
        }
        .footer-links a:hover {
            color: #66b1ff;
        }
        .footer-divider {
            width: 30px;
            height: 1px;
            background: #DCDFE6;
            margin: 8px 0;
        }
        .tab-equal-width .el-tabs__item {
            min-width: 90px;
            text-align: center;
        }
        .group-actions {
            display: flex;
            align-items: center;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="header">
            <h1>华巡网络设备巡检系统</h1>
            <div class="header-buttons">
                <div class="current-time">
                    <div class="date-time">{{ currentDateTime }}</div>
                    <div class="lunar-week">{{ lunarInfo }} {{ weekDay }}</div>
                </div>
                <el-button type="success" @click="exportDevices">
                    <i class="el-icon-download"></i> 导出设备
                </el-button>
                <el-button type="warning" @click="showImportDialog">
                    <i class="el-icon-upload"></i> 导入设备
                </el-button>
                <el-button type="primary" @click="showAddDeviceDialog">添加设备</el-button>
            </div>
        </div>

        <div class="device-list">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2 style="margin: 0;">设备列表</h2>
                <div>
                    <el-button type="success" size="small" @click="showGroupManagerDialog">
                        <i class="el-icon-folder"></i> 管理分组
                    </el-button>
                    <el-button type="primary" @click="showAddDeviceDialog">添加设备</el-button>
                </div>
            </div>
            <el-tabs v-model="activeDeviceGroupTab" type="card" class="tab-equal-width">
                <el-tab-pane label="全部设备" name="all">
                    <el-table 
                        :data="devices.slice((currentPage - 1) * pageSize, currentPage * pageSize)" 
                        style="width: 100%"
                        @selection-change="handleDeviceSelection"
                        row-key="id"
                        ref="deviceTable"
                        class="compact-table">
                        <el-table-column type="selection" width="55" reserve-selection></el-table-column>
                        <el-table-column prop="name" label="设备名称"></el-table-column>
                        <el-table-column prop="ip" label="IP地址"></el-table-column>
                        <el-table-column prop="device_type" label="设备类型"></el-table-column>
                        <el-table-column prop="group" label="分组"></el-table-column>
                        <el-table-column prop="protocol" label="协议" width="70"></el-table-column>
                        <el-table-column prop="status" label="状态" width="110">
                            <template slot-scope="scope">
                                <span :class="['status-badge', 'status-' + scope.row.status]">
                                    {{ getStatusText(scope.row.status) }}
                                </span>
                                <div v-if="scope.row.last_check" class="last-check">
                                    最后检查: {{ formatDate(scope.row.last_check) }}
                                </div>
                            </template>
                        </el-table-column>
                        <el-table-column label="操作" width="230">
                            <template slot-scope="scope">
                                <div class="operation-buttons">
                                    <el-button 
                                        size="mini" 
                                        type="primary" 
                                        @click="inspectDevice(scope.row)"
                                        :disabled="scope.row.status !== 'online'">
                                        巡检
                                    </el-button>
                                    <el-button 
                                        size="mini" 
                                        type="warning" 
                                        @click="showEditDeviceDialog(scope.row)">
                                        编辑
                                    </el-button>
                                    <el-button 
                                        size="mini" 
                                        type="danger" 
                                        @click="deleteDevice(scope.row)">
                                        删除
                                    </el-button>
                                </div>
                            </template>
                        </el-table-column>
                    </el-table>
                    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <el-button 
                                type="primary" 
                                @click="batchInspect"
                                :disabled="!selectedDevices.length">
                                批量巡检
                            </el-button>
                            <el-button 
                                type="danger" 
                                @click="batchDelete"
                                :disabled="!selectedDevices.length">
                                批量删除
                            </el-button>
                        </div>
                        <el-pagination
                            @current-change="handleDevicePageChange"
                            :current-page="currentPage"
                            :page-size="pageSize"
                            layout="prev, pager, next, total"
                            :total="devices.length">
                        </el-pagination>
                    </div>
                </el-tab-pane>
                <el-tab-pane 
                    v-for="group in deviceGroups" 
                    :key="group" 
                    :label="group" 
                    :name="group">
                    <el-table 
                        :data="filterDevicesByGroup(group).slice((groupPages[group] - 1) * pageSize, groupPages[group] * pageSize)" 
                        style="width: 100%"
                        @selection-change="handleGroupDeviceSelection"
                        row-key="id"
                        ref="groupDeviceTable"
                        class="compact-table">
                        <el-table-column type="selection" width="55" reserve-selection></el-table-column>
                        <el-table-column prop="name" label="设备名称"></el-table-column>
                        <el-table-column prop="ip" label="IP地址"></el-table-column>
                        <el-table-column prop="device_type" label="设备类型"></el-table-column>
                        <el-table-column prop="protocol" label="协议" width="70"></el-table-column>
                        <el-table-column prop="status" label="状态" width="110">
                            <template slot-scope="scope">
                                <span :class="['status-badge', 'status-' + scope.row.status]">
                                    {{ getStatusText(scope.row.status) }}
                                </span>
                                <div v-if="scope.row.last_check" class="last-check">
                                    最后检查: {{ formatDate(scope.row.last_check) }}
                                </div>
                            </template>
                        </el-table-column>
                        <el-table-column label="操作" width="230">
                            <template slot-scope="scope">
                                <div class="operation-buttons">
                                    <el-button 
                                        size="mini" 
                                        type="primary" 
                                        @click="inspectDevice(scope.row)"
                                        :disabled="scope.row.status !== 'online'">
                                        巡检
                                    </el-button>
                                    <el-button 
                                        size="mini" 
                                        type="warning" 
                                        @click="showEditDeviceDialog(scope.row)">
                                        编辑
                                    </el-button>
                                    <el-button 
                                        size="mini" 
                                        type="danger" 
                                        @click="deleteDevice(scope.row)">
                                        删除
                                    </el-button>
                                </div>
                            </template>
                        </el-table-column>
                    </el-table>
                    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <el-button 
                                type="primary" 
                                @click="batchInspectGroup"
                                :disabled="!selectedGroupDevices.length">
                                批量巡检
                            </el-button>
                            <el-button 
                                type="danger" 
                                @click="batchDeleteGroup"
                                :disabled="!selectedGroupDevices.length">
                                批量删除
                            </el-button>
                        </div>
                        <el-pagination
                            @current-change="(page) => handleGroupPageChange(group, page)"
                            :current-page="groupPages[group] || 1"
                            :page-size="pageSize"
                            layout="prev, pager, next, total"
                            :total="filterDevicesByGroup(group).length">
                        </el-pagination>
                    </div>
                </el-tab-pane>
            </el-tabs>
        </div>

        <div class="inspection-records">
            <h2>巡检记录</h2>
            <el-table 
                :data="inspectionRecords.slice((recordCurrentPage - 1) * recordPageSize, recordCurrentPage * recordPageSize)" 
                style="width: 100%"
                @selection-change="handleRecordSelection"
                row-key="id"
                ref="recordTable"
                class="compact-table">
                <el-table-column type="selection" width="55" reserve-selection></el-table-column>
                <el-table-column prop="device_name" label="设备名称"></el-table-column>
                <el-table-column prop="created_at" label="巡检时间" width="180">
                    <template slot-scope="scope">
                        {{ formatDateTime(scope.row.created_at) }}
                    </template>
                </el-table-column>
                <el-table-column label="结果" width="100">
                    <template slot-scope="scope">
                        <el-button type="text" @click="showResult(scope.row)">查看详情</el-button>
                    </template>
                </el-table-column>
                <el-table-column label="操作" width="180">
                    <template slot-scope="scope">
                        <div class="operation-buttons">
                            <el-button 
                                size="mini" 
                                type="primary" 
                                @click="exportRecord(scope.row)">
                                导出
                            </el-button>
                            <el-button 
                                size="mini" 
                                type="danger" 
                                @click="deleteRecord(scope.row)">
                                删除
                            </el-button>
                        </div>
                    </template>
                </el-table-column>
            </el-table>
            <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <el-button 
                        type="danger" 
                        @click="batchDeleteRecords"
                        :disabled="!selectedRecords.length">
                        批量删除
                    </el-button>
                    <el-button 
                        type="primary" 
                        @click="batchExportRecords"
                        :disabled="!selectedRecords.length">
                        批量导出
                    </el-button>
                </div>
                <el-pagination
                    @current-change="handleRecordPageChange"
                    :current-page="recordCurrentPage"
                    :page-size="recordPageSize"
                    layout="prev, pager, next, total"
                    :total="inspectionRecords.length">
                </el-pagination>
            </div>
        </div>

        <!-- 添加设备对话框 -->
        <el-dialog title="添加设备" :visible.sync="addDeviceDialogVisible" :close-on-click-modal="false" width="600px">
            <el-form :model="newDevice" :rules="rules" ref="deviceForm" label-width="120px">
                <el-form-item label="设备名称" prop="name">
                    <el-input v-model="newDevice.name" placeholder="请输入设备名称"></el-input>
                </el-form-item>
                <el-form-item label="IP地址" prop="ip">
                    <el-input v-model="newDevice.ip" placeholder="请输入IP地址"></el-input>
                </el-form-item>
                <el-form-item label="用户名" prop="username">
                    <el-input v-model="newDevice.username" placeholder="请输入用户名"></el-input>
                </el-form-item>
                <el-form-item label="密码" prop="password">
                    <el-input type="password" v-model="newDevice.password" placeholder="请输入密码"></el-input>
                </el-form-item>
                <el-form-item label="Enable密码" prop="enable_password">
                    <el-input type="password" v-model="newDevice.enable_password" placeholder="请输入Enable密码（可选）"></el-input>
                </el-form-item>
                <el-form-item label="设备类型" prop="device_type">
                    <el-select v-model="newDevice.device_type" placeholder="请选择设备类型">
                        <el-option label="Cisco IOS" value="cisco_ios"></el-option>
                        <el-option label="Cisco NX-OS" value="cisco_nxos"></el-option>
                        <el-option label="Juniper JunOS" value="juniper_junos"></el-option>
                        <el-option label="Huawei VRP" value="huawei"></el-option>
                        <el-option label="H3C Comware" value="hp_comware"></el-option>
                        <el-option label="锐捷交换机" value="ruijie_os"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="设备分组" prop="group">
                    <el-select v-model="newDevice.group" placeholder="请选择设备分组" allow-create filterable>
                        <el-option 
                            v-for="item in deviceGroups" 
                            :key="item" 
                            :label="item" 
                            :value="item">
                        </el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="连接协议" prop="protocol">
                    <el-radio-group v-model="newDevice.protocol">
                        <el-radio label="ssh">SSH</el-radio>
                        <el-radio label="telnet">Telnet</el-radio>
                    </el-radio-group>
                </el-form-item>
                <el-form-item label="巡检命令" prop="commands">
                    <el-input type="textarea" v-model="newDevice.commands" :rows="3" placeholder="请输入巡检命令，多个命令用逗号分隔"></el-input>
                    <div class="command-tips">
                        <p>常用命令示例：</p>
                        <ul>
                            <li>show version - 显示版本信息</li>
                            <li>show interfaces status - 显示接口状态</li>
                            <li>show running-config - 显示运行配置</li>
                            <li>show ip interface brief - 显示IP接口摘要</li>
                            <li>show logging - 显示日志信息</li>
                        </ul>
                    </div>
                </el-form-item>
            </el-form>
            <div slot="footer">
                <el-button @click="addDeviceDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="addDevice" :loading="addingDevice">确定</el-button>
            </div>
        </el-dialog>

        <!-- 巡检结果对话框 -->
        <el-dialog title="巡检结果" :visible.sync="resultDialogVisible" width="80%">
            <div class="inspection-result">
                <template v-if="formattedResult">
                    <div v-for="(item, index) in formattedResult" :key="index" class="command-result">
                        <div class="command-title">命令: {{ item.command }}</div>
                        <pre class="command-output">{{ item.output }}</pre>
                    </div>
                </template>
            </div>
        </el-dialog>

        <!-- 导入设备对话框 -->
        <el-dialog title="导入设备" :visible.sync="importDialogVisible" :close-on-click-modal="false" width="500px">
            <el-upload
                class="upload-demo"
                drag
                action="http://localhost:5000/api/devices/import"
                :on-success="handleImportSuccess"
                :on-error="handleImportError"
                :before-upload="beforeImportUpload"
                accept=".xlsx">
                <i class="el-icon-upload"></i>
                <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
                <div class="el-upload__tip" slot="tip">只能上传 xlsx 文件</div>
            </el-upload>
            <div slot="footer">
                <el-button @click="importDialogVisible = false">关闭</el-button>
            </div>
        </el-dialog>

        <!-- 编辑设备对话框 -->
        <el-dialog title="编辑设备" :visible.sync="editDeviceDialogVisible" :close-on-click-modal="false" width="600px">
            <el-form :model="editingDevice" :rules="rules" ref="editDeviceForm" label-width="120px">
                <el-form-item label="设备名称" prop="name">
                    <el-input v-model="editingDevice.name" placeholder="请输入设备名称"></el-input>
                </el-form-item>
                <el-form-item label="IP地址" prop="ip">
                    <el-input v-model="editingDevice.ip" placeholder="请输入IP地址"></el-input>
                </el-form-item>
                <el-form-item label="用户名" prop="username">
                    <el-input v-model="editingDevice.username" placeholder="请输入用户名"></el-input>
                </el-form-item>
                <el-form-item label="密码" prop="password">
                    <el-input type="password" v-model="editingDevice.password" placeholder="请输入密码"></el-input>
                </el-form-item>
                <el-form-item label="Enable密码" prop="enable_password">
                    <el-input type="password" v-model="editingDevice.enable_password" placeholder="请输入Enable密码（可选）"></el-input>
                </el-form-item>
                <el-form-item label="设备类型" prop="device_type">
                    <el-select v-model="editingDevice.device_type" placeholder="请选择设备类型">
                        <el-option label="Cisco IOS" value="cisco_ios"></el-option>
                        <el-option label="Cisco NX-OS" value="cisco_nxos"></el-option>
                        <el-option label="Juniper JunOS" value="juniper_junos"></el-option>
                        <el-option label="Huawei VRP" value="huawei"></el-option>
                        <el-option label="H3C Comware" value="hp_comware"></el-option>
                        <el-option label="锐捷交换机" value="ruijie_os"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="设备分组" prop="group">
                    <el-select v-model="editingDevice.group" placeholder="请选择设备分组" allow-create filterable>
                        <el-option 
                            v-for="item in deviceGroups" 
                            :key="item" 
                            :label="item" 
                            :value="item">
                        </el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="连接协议" prop="protocol">
                    <el-radio-group v-model="editingDevice.protocol">
                        <el-radio label="ssh">SSH</el-radio>
                        <el-radio label="telnet">Telnet</el-radio>
                    </el-radio-group>
                </el-form-item>
                <el-form-item label="巡检命令" prop="commands">
                    <el-input type="textarea" v-model="editingDevice.commands" :rows="3" placeholder="请输入巡检命令，多个命令用逗号分隔"></el-input>
                    <div class="command-tips">
                        <p>Cisco常用命令示例：</p>
                        <ul>
                            <li>show version - 显示版本信息</li>
                            <li>show interfaces status - 显示接口状态</li>
                            <li>show running-config - 显示运行配置</li>
                            <li>show ip interface brief - 显示IP接口摘要</li>
                            <li>show logging - 显示日志信息</li>
                        </ul>
                    </div>
                </el-form-item>
            </el-form>
            <div slot="footer">
                <el-button @click="editDeviceDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="updateDevice" :loading="updatingDevice">保存</el-button>
            </div>
        </el-dialog>

        <!-- 巡检进度遮罩 -->
        <div class="inspection-progress" v-if="inspectionInProgress">
            <div class="inspection-progress-content">
                <i class="el-icon-loading inspection-icon"></i>
                <div class="progress-title">正在巡检设备</div>
                <el-progress :percentage="inspectionProgress" :stroke-width="15" :show-text="false"></el-progress>
                <div class="progress-info">
                    <p>当前设备: {{ currentInspectingDevice ? currentInspectingDevice.name : '' }}</p>
                    <p v-if="batchInspecting">进度: {{ completedInspections }}/{{ totalInspections }}</p>
                    <p>请耐心等待，巡检过程中请勿刷新页面...</p>
                </div>
            </div>
        </div>

        <!-- 页脚 -->
        <div class="footer">
            <div class="footer-content">
                <div class="footer-logo">华巡网络设备巡检系统</div>
                <div class="footer-divider"></div>
                <div class="footer-copyright">© {{ currentYear }} 2lodoss 版权所有</div>
                <div class="footer-links">
                    <a href="javascript:void(0)">使用说明</a>
                    <a href="javascript:void(0)">联系我们</a>
                    <a href="javascript:void(0)">技术支持</a>
                </div>
            </div>
        </div>

        <!-- 分组管理对话框 -->
        <el-dialog title="管理设备分组" :visible.sync="groupManagerDialogVisible" width="500px">
            <div style="margin-bottom: 15px">
                <el-input 
                    v-model="newGroupName" 
                    placeholder="输入新分组名称" 
                    style="width: 200px">
                </el-input>
                <el-button type="primary" @click="addGroup" :disabled="!newGroupName.trim()">添加分组</el-button>
            </div>
            <el-table :data="deviceGroups" style="width: 100%">
                <el-table-column prop="name" label="分组名称">
                    <template slot-scope="scope">
                        <el-input 
                            v-if="scope.row.editing" 
                            v-model="scope.row.editingName" 
                            size="small">
                        </el-input>
                        <span v-else>{{ scope.row }}</span>
                    </template>
                </el-table-column>
                <el-table-column label="操作" width="150">
                    <template slot-scope="scope">
                        <div v-if="scope.row.editing">
                            <el-button type="success" size="mini" @click="confirmEditGroup(scope.$index)">确定</el-button>
                            <el-button size="mini" @click="cancelEditGroup(scope.$index)">取消</el-button>
                        </div>
                        <div v-else>
                            <el-button type="primary" size="mini" @click="editGroup(scope.$index, scope.row)">编辑</el-button>
                            <el-button 
                                type="danger" 
                                size="mini" 
                                @click="deleteGroup(scope.$index, scope.row)"
                                :disabled="isDefaultGroup(scope.row)">
                                删除
                            </el-button>
                        </div>
                    </template>
                </el-table-column>
            </el-table>
            <div slot="footer">
                <el-button @click="groupManagerDialogVisible = false">关闭</el-button>
            </div>
        </el-dialog>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                devices: [],
                inspectionRecords: [],
                selectedDevices: [],
                selectedGroupDevices: [],
                selectedRecords: [],
                addDeviceDialogVisible: false,
                editDeviceDialogVisible: false,
                resultDialogVisible: false,
                groupManagerDialogVisible: false,
                newGroupName: '',
                formattedResult: null,
                addingDevice: false,
                updatingDevice: false,
                inspectionInProgress: false,
                inspectionProgress: 0,
                currentInspectingDevice: null,
                batchInspecting: false,
                completedInspections: 0,
                totalInspections: 0,
                activeDeviceGroupTab: 'all',
                deviceGroups: ['交换机', 'AP', 'PC', '路由器'],
                defaultGroups: ['交换机', 'AP', 'PC', '路由器'],
                groupPages: {},
                editingDevice: {
                    id: null,
                    name: '',
                    ip: '',
                    username: '',
                    password: '',
                    enable_password: '',
                    device_type: 'cisco_ios',
                    protocol: 'ssh',
                    commands: '',
                    group: '交换机'
                },
                newDevice: {
                    name: '',
                    ip: '',
                    username: '',
                    password: '',
                    enable_password: '',
                    device_type: 'cisco_ios',
                    protocol: 'ssh',
                    commands: 'show version,show interfaces status,show running-config',
                    group: '交换机'
                },
                rules: {
                    name: [
                        { required: true, message: '请输入设备名称', trigger: 'blur' }
                    ],
                    ip: [
                        { required: true, message: '请输入IP地址', trigger: 'blur' },
                        { pattern: /^(\d{1,3}\.){3}\d{1,3}$/, message: '请输入正确的IP地址格式', trigger: 'blur' }
                    ],
                    username: [
                        { required: true, message: '请输入用户名', trigger: 'blur' }
                    ],
                    password: [
                        { required: true, message: '请输入密码', trigger: 'blur' }
                    ],
                    device_type: [
                        { required: true, message: '请选择设备类型', trigger: 'change' }
                    ],
                    protocol: [
                        { required: true, message: '请选择连接协议', trigger: 'change' }
                    ],
                    group: [
                        { required: true, message: '请选择设备分组', trigger: 'change' }
                    ],
                    commands: [
                        { required: true, message: '请输入巡检命令', trigger: 'blur' }
                    ]
                },
                statusCheckInterval: null,
                importDialogVisible: false,
                currentPage: 1,
                pageSize: 10,
                recordCurrentPage: 1,
                recordPageSize: 10,
                currentDateTime: '',
                lunarInfo: '',
                weekDay: '',
                currentYear: new Date().getFullYear()
            },
            methods: {
                async fetchDevices() {
                    try {
                        const response = await axios.get('http://localhost:5000/api/devices');
                        // 在更新前保存已选择的设备ID
                        const selectedIds = this.selectedDevices.map(device => device.id);
                        this.devices = response.data;
                        
                        // 收集所有设备的分组信息，并确保deviceGroups包含所有存在的分组
                        const existingGroups = new Set();
                        this.devices.forEach(device => {
                            if (device.group) {
                                existingGroups.add(device.group);
                            }
                        });
                        
                        // 更新设备分组列表，保留已有分组并添加新分组
                        existingGroups.forEach(group => {
                            const normalizedGroup = group.trim();
                            if (normalizedGroup && !this.deviceGroups.some(g => 
                                typeof g === 'string' 
                                    ? g.toLowerCase() === normalizedGroup.toLowerCase()
                                    : g.originalName.toLowerCase() === normalizedGroup.toLowerCase()
                            )) {
                                this.deviceGroups.push(normalizedGroup);
                            }
                        });
                        
                        // 确保每个分组都有对应的分页状态
                        this.deviceGroups.forEach(group => {
                            if (!this.groupPages[group]) {
                                this.$set(this.groupPages, group, 1);
                            }
                        });
                        
                        // 如果有选中的设备，在更新数据后重新设置选中状态
                        if (selectedIds.length > 0) {
                            console.log("保持选中的设备ID:", selectedIds);
                            // 稍微延迟以确保表格已更新
                            setTimeout(() => {
                                // 这里不直接设置selectedDevices，让表格通过selection-change事件设置
                                this.$refs.deviceTable.clearSelection();
                                this.devices.forEach(device => {
                                    if (selectedIds.includes(device.id)) {
                                        this.$refs.deviceTable.toggleRowSelection(device, true);
                                    }
                                });
                            }, 100);
                        }
                    } catch (error) {
                        this.$message.error('获取设备列表失败: ' + (error.response?.data?.error || error.message));
                    }
                },
                async fetchInspectionRecords() {
                    try {
                        // 保存已选择的记录ID
                        const selectedIds = this.selectedRecords.map(record => record.id);
                        
                        // 获取所有设备的巡检记录
                        const records = [];
                        for (const device of this.devices) {
                            try {
                                const response = await axios.get(`http://localhost:5000/api/devices/${device.id}/records`);
                                if (response.data && Array.isArray(response.data)) {
                                    records.push(...response.data);
                                }
                            } catch (error) {
                                console.error(`获取设备 ${device.name} 的巡检记录失败:`, error);
                            }
                        }
                        // 按时间倒序排序
                        this.inspectionRecords = records.sort((a, b) => 
                            new Date(b.created_at) - new Date(a.created_at)
                        );
                        console.log('获取到的巡检记录:', this.inspectionRecords);
                        
                        // 如果有选中的记录，在更新数据后重新设置选中状态
                        if (selectedIds.length > 0) {
                            console.log("保持选中的记录ID:", selectedIds);
                            // 稍微延迟以确保表格已更新
                            setTimeout(() => {
                                // 这里不直接设置selectedRecords，让表格通过selection-change事件设置
                                this.$refs.recordTable.clearSelection();
                                this.inspectionRecords.forEach(record => {
                                    if (selectedIds.includes(record.id)) {
                                        this.$refs.recordTable.toggleRowSelection(record, true);
                                    }
                                });
                            }, 100);
                        }
                    } catch (error) {
                        console.error('获取巡检记录失败:', error);
                        this.$message.error('获取巡检记录失败: ' + (error.response?.data?.error || error.message));
                    }
                },
                showAddDeviceDialog() {
                    this.addDeviceDialogVisible = true;
                    this.newDevice = {
                        name: '',
                        ip: '',
                        username: '',
                        password: '',
                        enable_password: '',
                        device_type: 'cisco_ios',
                        protocol: 'ssh',
                        commands: 'show version,show interfaces status,show running-config',
                        group: '交换机'
                    };
                },
                showEditDeviceDialog(device) {
                    this.editDeviceDialogVisible = true;
                    // 深拷贝设备信息，防止直接修改原对象
                    this.editingDevice = JSON.parse(JSON.stringify(device));
                },
                async addDevice() {
                    try {
                        // 处理巡检命令字符串，拆分为数组并清理
                        const commands = this.newDevice.commands
                            .split(',')
                            .map(cmd => {
                                // 移除所有可能的引号和方括号
                                cmd = cmd.replace(/["'\[\]]/g, '');
                                return cmd.trim();
                            })
                            .filter(cmd => cmd);
                        
                        // 标准化分组名称，确保与已有分组格式一致
                        // 检查是否是已存在的分组（不区分大小写）
                        let normalizedGroup = this.newDevice.group.trim();
                        for (const existingGroup of this.deviceGroups) {
                            const existingGroupStr = typeof existingGroup === 'string' ? 
                                existingGroup : existingGroup.originalName;
                            if (existingGroupStr.toLowerCase() === normalizedGroup.toLowerCase()) {
                                normalizedGroup = existingGroupStr; // 使用现有分组的确切大小写
                                break;
                            }
                        }
                        
                        // 创建要发送的设备数据
                        const deviceData = {
                            ...this.newDevice,
                            group: normalizedGroup,
                            commands: commands.join(',')  // 使用逗号分隔的字符串
                        };
                        
                        this.addingDevice = true;
                        await axios.post('http://localhost:5000/api/devices', deviceData);
                        this.$message.success('设备添加成功');
                        this.addDeviceDialogVisible = false;
                        this.newDevice = {
                            name: '',
                            ip: '',
                            username: '',
                            password: '',
                            enable_password: '',
                            device_type: 'cisco_ios',
                            protocol: 'ssh',
                            commands: '',
                            group: '交换机'
                        };
                        await this.fetchDevices();
                    } catch (error) {
                        this.$message.error('添加设备失败: ' + (error.response?.data?.error || error.message));
                    } finally {
                        this.addingDevice = false;
                    }
                },
                async updateDevice() {
                    try {
                        // 处理巡检命令字符串，拆分为数组并清理
                        const commands = this.editingDevice.commands
                            .split(',')
                            .map(cmd => {
                                // 移除所有可能的引号和方括号
                                cmd = cmd.replace(/["'\[\]]/g, '');
                                return cmd.trim();
                            })
                            .filter(cmd => cmd);
                        
                        // 标准化分组名称，确保与已有分组格式一致
                        // 检查是否是已存在的分组（不区分大小写）
                        let normalizedGroup = this.editingDevice.group.trim();
                        for (const existingGroup of this.deviceGroups) {
                            const existingGroupStr = typeof existingGroup === 'string' ? 
                                existingGroup : existingGroup.originalName;
                            if (existingGroupStr.toLowerCase() === normalizedGroup.toLowerCase()) {
                                normalizedGroup = existingGroupStr; // 使用现有分组的确切大小写
                                break;
                            }
                        }
                        
                        // 创建要发送的设备数据
                        const deviceData = {
                            ...this.editingDevice,
                            group: normalizedGroup,
                            commands: commands.join(',')  // 使用逗号分隔的字符串
                        };
                        
                        this.updatingDevice = true;
                        await axios.put(`http://localhost:5000/api/devices/${this.editingDevice.id}`, deviceData);
                        this.$message.success('设备更新成功');
                        this.editDeviceDialogVisible = false;
                        await this.fetchDevices();
                    } catch (error) {
                        this.$message.error('更新设备失败: ' + (error.response?.data?.error || error.message));
                    } finally {
                        this.updatingDevice = false;
                    }
                },
                async inspectDevice(device) {
                    try {
                        // 设置巡检状态和当前设备
                        this.inspectionInProgress = true;
                        this.currentInspectingDevice = device;
                        this.inspectionProgress = 0;
                        this.batchInspecting = false;
                        
                        // 模拟进度增加
                        const progressInterval = setInterval(() => {
                            if (this.inspectionProgress < 90) {
                                this.inspectionProgress += 10;
                            }
                        }, 500);
                        
                        const response = await axios.post(`http://localhost:5000/api/devices/${device.id}/inspect`);
                        
                        // 清除进度定时器
                        clearInterval(progressInterval);
                        this.inspectionProgress = 100;
                        
                        // 等待进度条完成动画
                        setTimeout(async () => {
                            this.inspectionInProgress = false;
                            this.currentInspectingDevice = null;
                            
                            if (response.data.success) {
                                this.$message.success('巡检完成');
                                // 刷新巡检记录
                                await this.fetchInspectionRecords();
                            } else {
                                throw new Error(response.data.message || '巡检失败');
                            }
                        }, 500);
                    } catch (error) {
                        this.inspectionInProgress = false;
                        this.currentInspectingDevice = null;
                        this.$message.error('巡检失败: ' + (error.response?.data?.message || error.message));
                    }
                },
                showResult(record) {
                    try {
                        this.formattedResult = JSON.parse(record.result)
                    } catch (e) {
                        this.formattedResult = null
                        this.$message.error('解析巡检结果失败')
                    }
                    this.resultDialogVisible = true
                },
                getStatusText(status) {
                    const statusMap = {
                        'online': '在线',
                        'offline': '离线',
                        'unknown': '未知'
                    }
                    return statusMap[status] || status
                },
                formatDate(dateStr) {
                    if (!dateStr) return ''
                    const date = new Date(dateStr)
                    return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`
                },
                formatDateTime(dateStr) {
                    if (!dateStr) return ''
                    const date = new Date(dateStr)
                    const year = date.getFullYear()
                    const month = (date.getMonth() + 1).toString().padStart(2, '0')
                    const day = date.getDate().toString().padStart(2, '0')
                    const hours = date.getHours().toString().padStart(2, '0')
                    const minutes = date.getMinutes().toString().padStart(2, '0')
                    const seconds = date.getSeconds().toString().padStart(2, '0')
                    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`
                },
                startStatusCheck() {
                    // 每30秒检查一次设备状态
                    this.statusCheckInterval = setInterval(() => {
                        this.fetchDevices()
                    }, 30000)
                },
                stopStatusCheck() {
                    if (this.statusCheckInterval) {
                        clearInterval(this.statusCheckInterval)
                        this.statusCheckInterval = null
                    }
                },
                updateDateTime() {
                    // 获取当前时间
                    const now = new Date();
                    
                    // 格式化日期和时间
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    const seconds = String(now.getSeconds()).padStart(2, '0');
                    
                    this.currentDateTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                    
                    // 获取星期
                    const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
                    this.weekDay = weekdays[now.getDay()];
                    
                    // 计算农历（简化版，仅作示例）
                    // 实际项目中可以使用专门的农历库，这里只是简单显示
                    this.lunarInfo = this.getLunarDate(year, parseInt(month), parseInt(day));
                },
                
                // 简化版农历计算函数
                getLunarDate(year, month, day) {
                    const lunarInfo = [
                        0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2,
                        0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977,
                        0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970,
                        0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950,
                        0x0d4a0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557
                    ];
                    
                    // 月份
                    const animals = ['鼠', '牛', '虎', '兔', '龙', '蛇', '马', '羊', '猴', '鸡', '狗', '猪'];
                    const zodiac = ['猴', '鸡', '狗', '猪', '鼠', '牛', '虎', '兔', '龙', '蛇', '马', '羊'];
                    
                    // 农历天干地支
                    const heavenlyStems = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
                    const earthlyBranches = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
                    
                    // 简单计算农历年份（不精确，仅作显示）
                    const yearOffset = year - 1900;
                    const animalIndex = yearOffset % 12;
                    const stemIndex = yearOffset % 10;
                    const branchIndex = yearOffset % 12;
                    
                    return `农历 ${heavenlyStems[stemIndex]}${earthlyBranches[branchIndex]}年 ${zodiac[month % 12]}月`;
                },
                async exportDevices() {
                    try {
                        window.location.href = 'http://localhost:5000/api/devices/export';
                    } catch (error) {
                        this.$message.error('导出设备失败: ' + (error.response?.data?.error || error.message));
                    }
                },
                showImportDialog() {
                    this.importDialogVisible = true;
                },
                beforeImportUpload(file) {
                    const isXLSX = file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                    if (!isXLSX) {
                        this.$message.error('只能上传 xlsx 文件!');
                        return false;
                    }
                    return true;
                },
                handleImportSuccess(response) {
                    if (response.success) {
                        this.$message.success(response.message);
                        if (response.error_count > 0) {
                            this.$message.warning(`有 ${response.error_count} 个设备导入失败`);
                            console.error('导入错误:', response.errors);
                        }
                        this.importDialogVisible = false;
                        this.fetchDevices();
                    } else {
                        this.$message.error(response.error || '导入失败');
                    }
                },
                handleImportError(error) {
                    this.$message.error('导入失败: ' + (error.response?.data?.error || error.message));
                },
                handleDeviceSelection(selection) {
                    console.log("设备选择变更:", selection);
                    this.selectedDevices = selection;
                },
                handleGroupDeviceSelection(selection) {
                    console.log("分组设备选择变更:", selection);
                    this.selectedGroupDevices = selection;
                },
                handleRecordSelection(selection) {
                    console.log("记录选择变更:", selection);
                    this.selectedRecords = selection;
                },
                async batchInspect() {
                    if (!this.selectedDevices.length) {
                        this.$message.warning('请选择要巡检的设备');
                        return;
                    }
                    
                    try {
                        // 设置批量巡检状态
                        this.inspectionInProgress = true;
                        this.batchInspecting = true;
                        this.completedInspections = 0;
                        
                        // 获取在线设备
                        const onlineDevices = this.selectedDevices.filter(device => device.status === 'online');
                        this.totalInspections = onlineDevices.length;
                        
                        if (onlineDevices.length === 0) {
                            this.$message.warning('所选设备中没有在线设备，无法进行巡检');
                            this.inspectionInProgress = false;
                            this.batchInspecting = false;
                            return;
                        }
                        
                        for (const device of onlineDevices) {
                            try {
                                // 更新当前巡检设备和进度
                                this.currentInspectingDevice = device;
                                this.inspectionProgress = 0;
                                
                                // 模拟进度增加
                                const progressInterval = setInterval(() => {
                                    if (this.inspectionProgress < 90) {
                                        this.inspectionProgress += 10;
                                    }
                                }, 500);
                                
                                // 执行巡检
                                const response = await axios.post(`http://localhost:5000/api/devices/${device.id}/inspect`);
                                
                                // 清除进度定时器
                                clearInterval(progressInterval);
                                this.inspectionProgress = 100;
                                
                                // 更新完成数量
                                this.completedInspections++;
                                
                                // 等待进度条完成动画
                                await new Promise(resolve => setTimeout(resolve, 500));
                                
                                if (!response.data.success) {
                                    throw new Error(response.data.message || '巡检失败');
                                }
                            } catch (error) {
                                console.error(`巡检设备 ${device.name} 失败: ${error.message}`);
                            }
                        }
                        
                        // 所有设备巡检完成
                        this.inspectionInProgress = false;
                        this.batchInspecting = false;
                        this.currentInspectingDevice = null;
                        this.$message.success('批量巡检完成');
                        
                        // 刷新巡检记录
                        await this.fetchInspectionRecords();
                    } catch (error) {
                        this.inspectionInProgress = false;
                        this.batchInspecting = false;
                        this.currentInspectingDevice = null;
                        this.$message.error('批量巡检失败: ' + error.message);
                    }
                },
                async batchDelete() {
                    if (!this.selectedDevices.length) {
                        this.$message.warning('请选择要删除的设备');
                        return;
                    }
                    try {
                        await this.$confirm('确定要删除选中的设备吗？', '提示', {
                            type: 'warning'
                        });
                        for (const device of this.selectedDevices) {
                            await axios.delete(`http://localhost:5000/api/devices/${device.id}`);
                        }
                        this.$message.success('批量删除成功');
                        await this.fetchDevices();
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.$message.error('批量删除失败: ' + error.message);
                        }
                    }
                },
                async batchDeleteRecords() {
                    if (!this.selectedRecords.length) {
                        this.$message.warning('请选择要删除的巡检记录');
                        return;
                    }
                    try {
                        await this.$confirm('确定要删除选中的巡检记录吗？', '提示', {
                            type: 'warning'
                        });
                        for (const record of this.selectedRecords) {
                            await axios.delete(`http://localhost:5000/api/records/${record.id}`);
                        }
                        this.$message.success('批量删除成功');
                        await this.fetchInspectionRecords();
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.$message.error('批量删除失败: ' + error.message);
                        }
                    }
                },
                handleDevicePageChange(page) {
                    this.currentPage = page;
                },
                handleGroupPageChange(group, page) {
                    this.$set(this.groupPages, group, page);
                },
                handleRecordPageChange(page) {
                    this.recordCurrentPage = page;
                },
                filterDevicesByGroup(group) {
                    // 日志输出，帮助调试
                    console.log(`正在过滤分组: "${group}"`);
                    console.log("所有设备:", this.devices.map(d => ({name: d.name, group: d.group})));
                    
                    const filtered = this.devices.filter(device => {
                        // 确保设备的group属性存在
                        if (!device.group) return false;
                        
                        // 日志输出，帮助调试
                        console.log(`比较: 设备 "${device.name}" 分组 "${device.group}" vs "${group}"`);
                        
                        // 不区分大小写比较
                        const deviceGroupLower = device.group.toLowerCase().trim();
                        const targetGroupLower = group.toLowerCase().trim();
                        const result = deviceGroupLower === targetGroupLower;
                        
                        console.log(`比较结果: ${result}, 设备组(小写): "${deviceGroupLower}", 目标组(小写): "${targetGroupLower}"`);
                        return result;
                    });
                    
                    console.log(`分组 "${group}" 过滤结果: ${filtered.length} 个设备`);
                    return filtered;
                },
                async batchInspectGroup() {
                    if (!this.selectedGroupDevices.length) {
                        this.$message.warning('请选择要巡检的设备');
                        return;
                    }
                    
                    try {
                        // 设置批量巡检状态
                        this.inspectionInProgress = true;
                        this.batchInspecting = true;
                        this.completedInspections = 0;
                        
                        // 获取在线设备
                        const onlineDevices = this.selectedGroupDevices.filter(device => device.status === 'online');
                        this.totalInspections = onlineDevices.length;
                        
                        if (onlineDevices.length === 0) {
                            this.$message.warning('所选设备中没有在线设备，无法进行巡检');
                            this.inspectionInProgress = false;
                            this.batchInspecting = false;
                            return;
                        }
                        
                        for (const device of onlineDevices) {
                            try {
                                // 更新当前巡检设备和进度
                                this.currentInspectingDevice = device;
                                this.inspectionProgress = 0;
                                
                                // 模拟进度增加
                                const progressInterval = setInterval(() => {
                                    if (this.inspectionProgress < 90) {
                                        this.inspectionProgress += 10;
                                    }
                                }, 500);
                                
                                // 执行巡检
                                const response = await axios.post(`http://localhost:5000/api/devices/${device.id}/inspect`);
                                
                                // 清除进度定时器
                                clearInterval(progressInterval);
                                this.inspectionProgress = 100;
                                
                                // 更新完成数量
                                this.completedInspections++;
                                
                                // 等待进度条完成动画
                                await new Promise(resolve => setTimeout(resolve, 500));
                                
                                if (!response.data.success) {
                                    throw new Error(response.data.message || '巡检失败');
                                }
                            } catch (error) {
                                console.error(`巡检设备 ${device.name} 失败: ${error.message}`);
                            }
                        }
                        
                        // 所有设备巡检完成
                        this.inspectionInProgress = false;
                        this.batchInspecting = false;
                        this.currentInspectingDevice = null;
                        this.$message.success('批量巡检完成');
                        
                        // 刷新巡检记录
                        await this.fetchInspectionRecords();
                    } catch (error) {
                        this.inspectionInProgress = false;
                        this.batchInspecting = false;
                        this.currentInspectingDevice = null;
                        this.$message.error('批量巡检失败: ' + error.message);
                    }
                },
                async batchDeleteGroup() {
                    if (!this.selectedGroupDevices.length) {
                        this.$message.warning('请选择要删除的设备');
                        return;
                    }
                    try {
                        await this.$confirm('确定要删除选中的设备吗？', '提示', {
                            type: 'warning'
                        });
                        for (const device of this.selectedGroupDevices) {
                            await axios.delete(`http://localhost:5000/api/devices/${device.id}`);
                        }
                        this.$message.success('批量删除成功');
                        await this.fetchDevices();
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.$message.error('批量删除失败: ' + error.message);
                        }
                    }
                },
                async deleteRecord(record) {
                    try {
                        await this.$confirm('确定要删除该巡检记录吗？', '提示', {
                            type: 'warning'
                        });
                        await axios.delete(`http://localhost:5000/api/records/${record.id}`);
                        this.$message.success('删除成功');
                        await this.fetchInspectionRecords();
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.$message.error('删除失败: ' + (error.response?.data?.error || error.message));
                        }
                    }
                },
                async deleteDevice(device) {
                    try {
                        await this.$confirm('确定要删除该设备吗？', '提示', {
                            type: 'warning'
                        });
                        await axios.delete(`http://localhost:5000/api/devices/${device.id}`);
                        this.$message.success('删除成功');
                        await this.fetchDevices();
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.$message.error('删除失败: ' + (error.response?.data?.error || error.message));
                        }
                    }
                },
                async exportRecord(record) {
                    try {
                        window.location.href = `http://localhost:5000/api/records/${record.id}/export`;
                    } catch (error) {
                        this.$message.error('导出巡检记录失败: ' + (error.response?.data?.error || error.message));
                    }
                },
                async batchExportRecords() {
                    if (!this.selectedRecords.length) {
                        this.$message.warning('请选择要导出的巡检记录');
                        return;
                    }
                    
                    try {
                        // 获取所有选中记录的ID
                        const recordIds = this.selectedRecords.map(record => record.id);
                        // 将ID数组转换为查询参数字符串
                        const queryParams = recordIds.map(id => `id=${id}`).join('&');
                        // 触发下载
                        window.location.href = `http://localhost:5000/api/records/batch-export?${queryParams}`;
                    } catch (error) {
                        this.$message.error('批量导出巡检记录失败: ' + error.message);
                    }
                },
                showGroupManagerDialog() {
                    // 转换分组数组为对象数组，以便支持编辑功能
                    this.groupManagerDialogVisible = true;
                    this.newGroupName = '';
                },
                isDefaultGroup(group) {
                    return this.defaultGroups.some(dg => 
                        typeof dg === 'string' 
                            ? dg.toLowerCase() === group.toLowerCase()
                            : dg.originalName.toLowerCase() === group.toLowerCase()
                    );
                },
                addGroup() {
                    let groupName = this.newGroupName.trim();
                    if (!groupName) return;
                    
                    // 检查是否已存在（不区分大小写）
                    if (this.deviceGroups.some(g => 
                        typeof g === 'string' 
                            ? g.toLowerCase() === groupName.toLowerCase() 
                            : g.originalName.toLowerCase() === groupName.toLowerCase()
                    )) {
                        this.$message.warning('该分组名称已存在');
                        return;
                    }
                    
                    this.deviceGroups.push(groupName);
                    this.newGroupName = '';
                    this.$message.success('分组添加成功');
                },
                editGroup(index, group) {
                    // 因为deviceGroups是字符串数组，这里需要转换成可编辑对象
                    this.$set(this.deviceGroups, index, {
                        originalName: group,
                        editingName: group,
                        editing: true
                    });
                },
                confirmEditGroup(index) {
                    const editingGroup = this.deviceGroups[index];
                    const newName = editingGroup.editingName.trim();
                    const oldName = editingGroup.originalName;
                    
                    if (!newName) {
                        this.$message.warning('分组名称不能为空');
                        return;
                    }
                    
                    // 检查是否已存在（不区分大小写）
                    if (this.deviceGroups.some((g, i) => i !== index && (
                        typeof g === 'string' 
                            ? g.toLowerCase() === newName.toLowerCase() 
                            : g.originalName.toLowerCase() === newName.toLowerCase()
                    ))) {
                        this.$message.warning('该分组名称已存在');
                        return;
                    }
                    
                    // 更新分组名称
                    this.$set(this.deviceGroups, index, newName);
                    
                    // 更新所有设备的分组
                    this.devices.forEach(device => {
                        if (device.group.toLowerCase() === oldName.toLowerCase()) {
                            device.group = newName;
                        }
                    });
                    
                    // 更新后端数据
                    this.updateDevicesGroup(oldName, newName);
                    
                    this.$message.success('分组名称已更新');
                },
                cancelEditGroup(index) {
                    // 取消编辑，恢复原名称
                    const originalName = this.deviceGroups[index].originalName;
                    this.$set(this.deviceGroups, index, originalName);
                },
                async deleteGroup(index, group) {
                    try {
                        // 默认分组不允许删除
                        if (this.isDefaultGroup(group)) {
                            this.$message.warning('默认分组不能删除');
                            return;
                        }
                        
                        await this.$confirm(`确定要删除分组"${group}"吗？相关设备将移至"交换机"分组`, '提示', {
                            type: 'warning'
                        });
                        
                        // 将该分组下的设备移到默认分组
                        this.devices.forEach(device => {
                            if (device.group.toLowerCase() === group.toLowerCase()) {
                                device.group = '交换机';
                            }
                        });
                        
                        // 更新设备分组信息
                        this.updateDevicesGroup(group, '交换机');
                        
                        // 移除分组
                        this.deviceGroups.splice(index, 1);
                        
                        // 如果当前选中的是被删除的分组，切换到全部分组
                        if (this.activeDeviceGroupTab === group) {
                            this.activeDeviceGroupTab = 'all';
                        }
                        
                        this.$message.success('分组已删除');
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.$message.error('删除分组失败: ' + error);
                        }
                    }
                },
                async updateDevicesGroup(oldGroup, newGroup) {
                    // 获取旧分组下的所有设备
                    const devicesInGroup = this.devices.filter(device => 
                        device.group.toLowerCase() === oldGroup.toLowerCase());
                    
                    // 批量更新设备分组
                    for (const device of devicesInGroup) {
                        try {
                            const updatedDevice = {...device, group: newGroup};
                            await axios.put(`http://localhost:5000/api/devices/${device.id}`, updatedDevice);
                        } catch (error) {
                            console.error(`更新设备 ${device.name} 的分组失败:`, error);
                        }
                    }
                    
                    // 刷新设备列表
                    await this.fetchDevices();
                }
            },
            mounted() {
                // 初始化时首先更新日期时间
                this.updateDateTime();
                
                // 设置定时器每秒更新一次时间
                setInterval(() => {
                    this.updateDateTime();
                }, 1000);
                
                // 获取设备列表和巡检记录
                this.fetchDevices().then(() => {
                    this.fetchInspectionRecords();
                });
                
                // 启动设备状态检查
                this.startStatusCheck();
            },
            beforeDestroy() {
                // 组件销毁前清除定时器
                this.stopStatusCheck();
            }
        });
    </script>
</body>
</html> 